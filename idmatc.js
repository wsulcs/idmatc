// YouTube videos of IDM and ambient tracks...
var playlists = [
    {
        title: 'Assorted cherrypicks from Intelligent Dance Music playlist',
        // playlistId: 'PL4ZNQcArsz2ZOOdVmD1dDkNfFL4swdX14',
        include: true,
        entries: [
            'n0P1JsMTWc0',
            '-CWCBiOZK1U',
            '28cYwmkrRQ8',
            'dQEmaj9C6ko',
            '5GU50vjMxZU',
            'GYZqhYl12Nw',
            '5cJLfzTSsTc',
            'cmR4QHwlshw',
            'mh5su4GgOBY',
            'mehLx_Fjv_c',
            'dLHtV_S2HZw',
            'vJwuUvbWGXE',
            'h4_VxWfaa2g',
            '87pZCUrmVbU',
            'vBroTgiw30g',
            'eh-zNUw3u1I',
            '2FAGW_OCebc',
            'nGKZMMf68Ak',
            'guvFj1_INzs',
            'gU3piM6whg8',
            'usbkSZBvxIg',
            'xUN7vdZKsWw',
            'YR_l9X6mqBc',
            '8-2oC1NyDQo',
            'e0q1ZjCrPLI',
            'tRNwphaTHYA'
            ]
    },
    {
        title: 'Access to Arasaka - void()',
        include: true,
        entries: [
            'tmSwKryZT1E',
            'YLG6Kb8BE1Q',
            'teKu7V2kLEQ',
            'u-NfLDxIZJY',
            'cMcpCvC5BFE',
            'dcifugxZMiM',
            'YJj4xUW5JlI',
            'e-PWRitodF0',
            'cL7blDmn-Uw',
            'lgEgdVGHSZ0',
            'F-0oxRMqPww',
            'QHajw-rHTIg',
            'Q_CwQmw3iuA',
            'sle3hhihpLo',
            'LljmPr9sd80',
            'c21MOtTKS6w'
            ]
    },
    {
        title: 'Access to Arasaka - Geosynchon tracks',
        include: true,
        entries: [
            'eVf-oIvUvCU',
            'RJim16CFz00',
            'e4JNg5QBC7Y',
            '3DxmKRC5ATc',
            'Pwa-mynF6-M',
            'THLYChHVx-k',
            'tpqiw7uyZkg',
            '5i7EOCU09pg',
            'oZIXFqovIpE',
            'D7m-83TY7D4',
            'TGIf_FAE4rg'
            ]
    },
    {
        title: 'Access to Arasaka - void()',
        include: true,
        entries: [
            'ptu4Zp3PHHA',
            '_f8FUtViXrI',
            'UDV90R1kD8w',
            '-2N-tZRRU8A',
            'RJlSaObJMIc',
            'qQ2qbhs-NEQ',
            'afb7jk3A5qs',
            'i6nKvSYN4Yg',
            'QM_F3BLjmd0',
            'UB-aj9z34-g',
            'hVNHvc30L40',
            'KfiWIIJD1AE',
            'ZRmkyxS8aRI',
            'RjYv09k6WVo'
            ]
    },
    {
        title: 'Proem - Negativ tracks',
        include: true,
        entries: [
            'wGL059ARmt4',
            '_HcZndLtKoI',
            '4bys153FV5U',
            '32mUCmOmwmg',
            'kI0rh5JXaXI',
            'kbWg_FPx7v4',
            'sj2h5hbJMv4',
            'a1GWjBjtwRo',
            'v-35me0oRXY',
            'IuRYFnePxrY',
            'J2_FvdlqzQo',
            'TCWLkQSdXGA'
            ]
    },
    {
        title: 'Proem - Negativ tracks',
        include: true,
        entries: [
            'wGL059ARmt4',
            '_HcZndLtKoI',
            '4bys153FV5U',
            '32mUCmOmwmg',
            'kI0rh5JXaXI',
            'kbWg_FPx7v4',
            'sj2h5hbJMv4',
            'a1GWjBjtwRo',
            'v-35me0oRXY',
            'IuRYFnePxrY',
            'J2_FvdlqzQo',
            'TCWLkQSdXGA'
            ]
    },
    {
        title: 'Proem - Enough Conflict some tracks',
        include: true,
        entries: [
            'ARaglPmYQ_g',
            'eX2VhrMBKY4',
            'ep-qpyBVI3A',
            'nKUJrR5-JAg',
            'ZQrcz5jC7x0',
            'llIdYfQOBSg',
            'qm06Mw-R3VE'
            ]
    },
    {
        title: 'Boards of Canada - various tracks',
        include: true,
        entries: [
            'zV0P-WO0Mds',
            'KZbFpcEl-8o',
            'XrjvFzH2ALM',
            'lhPWJHrwgR4',
            'VF-ToDzj0ig',
            'Hr3P118yLDs',
            'aj6_oGfABo8',
            'fk4MFI-u2tI',
            'VCcU-vg-woY',
            'soAH__YofsM',
            'lzuxd3CQqw0',
            'RQef_-Y_Imo',
            'sSWYb9Z5fNY',
            '0nnqGDZnWhU',
            '8Kban1IOQ4M',
            'n420JT35bW4',
            'p32Ldr0XY3c',
            'WZDbGTNvOoU'
            ]
    },
    {
        title: 'Autechre - various tracks',
        include: true,
        entries: [
            '-F665Mkc0D0',
            'Z5JdhYNz8ek',
            'NrGIJjUDLkI',
            '08vR-VL2RzE',
            '13ZJ4_y30Ok',
            'B3H8AYMCyBA',
            'SGfIoemf-aQ',
            'h_segRH6LKA',
            'HB2NJ8deZ64',
            'TZ7RF7dCCgc',
            'jWy9O6MdSJM',
            'vUioVGqfu6s',
            'Df2fgXORCMU',
            'pcofr1Fl1F4',
            'SyPSxfSw23s',
            'CZXeG9qmFzc',
            'Ip1QZJNqaIE',
            'OpoOCv0MeKs'
            ]
    },
    {
        title: 'Arovane tracks',
        include: true,
        entries: [
            '6tQw6RjECl8',
            'o1YGwSHpXNA',
            'elPLLFc2eeM',
            'pE77NgQ9zEc',
            'riEUUCnMNGo',
            'n-seBvNIV2I',
            'IGCjDHxM-FI',
            '-NbV-ku11UI',
            '31OjcV-BZHc',
            '8eewu1zALgQ',
            'Ffo1737LVoo',
            '_xL-fIBJrQU'
            ]
    },
    {
        title: 'Gridlock',
        include: true,
        entries: [
            'aa2o8F3VS-8',
            'M358JcdR_Ak',
            'uKi00NDtQnQ',
            'oIrQW3vVfTU',
            'dOUmHZalC4k',
            'rUTgvawYphA',
            'tOyB9Lqkq6k',
            'Ox7nf-g3B6Q',
            'tSjpy6cybe4',
            'pC-2gMe1tzU'
            ]
    },
    {
        title: 'Yeah, yeah, shameless me',
        include: true,
        entries: [
            'pSwGMVB4AhU',
            'vKbHtrMfrOU',
            '91Hy8qMCok4',
            '2GTs-e7pjTE',
            'QcoIK-1yd_Y',
            'haPNX2_aTFg',
            'cTz4a1r-dvk'
        ]
    },
];

// ATC streams...
var atcStreams = [
    { url: 'https://s1-bos.liveatc.net/cyul_app', name: 'Canada - Montreal: CYUL Approach/Departure' },
    { url: 'https://s1-bos.liveatc.net/cywg2_misc', name: 'Canada - Winnipeg: CYWG Del/Gnd/Twr' },
    { url: 'https://s1-bos.liveatc.net/cyyz6', name: 'Canada - Toronto: CYYZ Arrival' },
    { url: 'https://s1-bos.liveatc.net/cyyz7', name: 'Canada - Toronto: CYYZ Tower' },
    { url: 'https://s1-bos.liveatc.net/eidw3', name: 'Ireland - Dublin: EIDW Del/Gnd/Twr/App/Center' },
    { url: 'https://s1-bos.liveatc.net/katl_twr', name: 'United States - Atlanta: KATL Tower' },
    { url: 'https://s1-bos.liveatc.net/kbos_twr', name: 'United States - Boston: KBOS Tower' },
    { url: 'https://s1-bos.liveatc.net/kcno', name: 'United States - Chino: KCNO Ground/Tower' },
    { url: 'https://s1-bos.liveatc.net/kdca2_twr', name: 'United States - Washington: KDCA Tower #1' },
    { url: 'https://s1-bos.liveatc.net/kden1_1', name: 'United States - Denver: KDEN Approach' },
    { url: 'https://s1-bos.liveatc.net/kden1_3', name: 'United States - Denver: KDEN Tower' },
    { url: 'https://s1-bos.liveatc.net/kden1_9', name: 'United States - Denver: KDEN Clearance/Ground' },
    { url: 'https://s1-bos.liveatc.net/kewr_twr', name: 'United States - Newark: KEWR Tower' },
    { url: 'https://s1-bos.liveatc.net/kjfk_dep', name: 'United States - New York: NY Departure (JFK)' },
    { url: 'https://s1-bos.liveatc.net/kjfk9_s', name: 'United States - New York: KJFK Gnd/Twr' },
    { url: 'https://s1-bos.liveatc.net/klas4_twr', name: 'United States - Las Vegas: KLAS Tower (Both)' },
    { url: 'https://s1-bos.liveatc.net/klax_twr', name: 'United States - Los Angeles: KLAX Tower (North/South) #1' },
    { url: 'https://s1-bos.liveatc.net/klax3', name: 'United States - Los Angeles: KLAX Tower (North) #1' },
    { url: 'https://s1-bos.liveatc.net/klax4', name: 'United States - Los Angeles: KLAX Tower (South) #1' },
    { url: 'https://s1-bos.liveatc.net/klax6', name: 'United States - Los Angeles: KLAX Final App (North/South)' },
    { url: 'https://s1-bos.liveatc.net/kord7', name: 'United States - Chicago: KORD Tower' },
    { url: 'https://s1-bos.liveatc.net/kpdx3_twr', name: 'United States - Portland: KPDX Tower (Both)' },
    { url: 'https://s1-bos.liveatc.net/kphx_twr_both', name: 'United States - Phoenix: KPHX Tower (North/South)' },
    { url: 'https://s1-bos.liveatc.net/ksan1_all', name: 'United States - San Diego: KSAN Ramp/Del/Gnd/Twr' },
    { url: 'https://s1-bos.liveatc.net/ksea2_twr_e', name: 'United States - Seattle: KSEA Tower (16L/34R,16C/34C) #2' },
    { url: 'https://s1-bos.liveatc.net/ksfo_twr', name: 'United States - San Francisco: KSFO Tower' },
    { url: 'https://s1-bos.liveatc.net/ktus', name: 'United States - Tucson: KDMA/KTUS Twr/Ops/ZAB' },
    { url: 'https://s1-bos.liveatc.net/ktyr2_ctr', name: 'United States - Tyler: ZFW Sector 25' },
    { url: 'https://s1-bos.liveatc.net/mmmx1_twr', name: 'Mexico - Mexico City: MMMX Tower' },
    { url: 'https://s1-bos.liveatc.net/mroc', name: 'Costa Rica - San Jose: MROC Del/Gnd/Twr/App/Center/Misc' },
    { url: 'https://s1-bos.liveatc.net/panc', name: 'United States - Anchorage: PANC Del/Gnd/Twr/App' },
    { url: 'https://s1-bos.liveatc.net/phnl1_twr_pri', name: 'United States - Honolulu: PHNL Tower (Primary)' },
    { url: 'https://s1-bos.liveatc.net/rcss2', name: 'Taiwan - Taipei: RCSS Tower/App/Dep' },
    { url: 'https://s1-bos.liveatc.net/rjaa_app_s', name: 'Japan - Tokyo: RJAA Approach' },
    { url: 'https://s1-bos.liveatc.net/rjaa_twr', name: 'Japan - Tokyo: RJAA Tower (Both)' },
    { url: 'https://s1-bos.liveatc.net/rjoo1', name: 'Japan - Osaka: RJOO Tower' },
    { url: 'https://s1-bos.liveatc.net/rjtt_app_dep', name: 'Japan - Tokyo: RJTT App/Dep' },
    { url: 'https://s1-bos.liveatc.net/rjtt_app', name: 'Japan - Tokyo: RJTT Approach' },
    { url: 'https://s1-bos.liveatc.net/rjtt_control', name: 'Japan - Tokyo: RJTT Tokyo Control' },
    { url: 'https://s1-bos.liveatc.net/rjtt_dep', name: 'Japan - Tokyo: RJTT Departure' },
    { url: 'https://s1-bos.liveatc.net/rjtt_twr', name: 'Japan - Tokyo: RJTT Twr/TCA' },
    { url: 'https://s1-bos.liveatc.net/rjtt2', name: 'Japan - Tokyo: RJTT Company Channels' },
    { url: 'https://s1-bos.liveatc.net/rjty1_app', name: 'Japan - Tokyo: RJTY Approach' },
    { url: 'https://s1-bos.liveatc.net/rjty1_gnd_twr', name: 'Japan - Tokyo: RJTY Ground/Tower' },
    { url: 'https://s1-bos.liveatc.net/unnt', name: 'Russia - Novosibirsk: UNNT Gnd/Twr/App/Radar/Misc' },
    { url: 'https://s1-bos.liveatc.net/vhhh5', name: 'Hong Kong - Hong Kong: VHHH App/Dep/Dir/Zone' },
    { url: 'https://s1-bos.liveatc.net/ypdn', name: 'Australia - Darwin: YPDN Gnd/Twr/App/Dep' },
    { url: 'https://s1-bos.liveatc.net/yssy1_twr', name: 'Australia - Sydney: YSSY Tower (Both)' },
    { url: 'https://s1-bos.liveatc.net/zoa_35', name: 'United States - San Francisco: ZOA Oakland Center (35)' },
    { url: 'https://s1-bos.liveatc.net/zoa_sfo', name: 'United States - San Francisco: ZOA Oakland Center (35/40/41)' },
    { url: "https://s1-bos.liveatc.net/cyyz7", name: "Canada - Toronto: CYYZ Tower" },
    { url: "https://s1-bos.liveatc.net/eidw3", name: "Ireland - Dublin: EIDW Del/Gnd/Twr/App/Center" },
    { url: "https://s1-bos.liveatc.net/kapa2_twr1", name: "United States - Denver: KAPA Tower (Primary)" },
    { url: "https://s1-bos.liveatc.net/katl_twr", name: "United States - Atlanta: KATL Tower" },
    { url: "https://s1-bos.liveatc.net/kbfi", name: "United States - Seattle: KBFI Ground/Tower" },
    { url: "https://s1-bos.liveatc.net/kbjc3", name: "United States - Denver: KBJC Ground/Tower" },
    { url: "https://s1-bos.liveatc.net/kbos_twr", name: "United States - Boston: KBOS Tower" },
    { url: "https://s1-bos.liveatc.net/kbwi_twr", name: "United States - Baltimore: KBWI Tower" },
    { url: "https://s1-bos.liveatc.net/kden1_1", name: "United States - Denver: KDEN Approach" },
    { url: "https://s1-bos.liveatc.net/kden1_3", name: "United States - Denver: KDEN Tower" },
    { url: "https://s1-bos.liveatc.net/kdfw1_twr1_w", name: "United States - Dallas: KDFW Tower (West)" },
    { url: "https://s1-bos.liveatc.net/kewr_gnd_pri", name: "United States - Newark: KEWR Ground" },
    { url: "https://s1-bos.liveatc.net/kjfk_dep", name: "United States - New York: NY Departure (JFK)" },
    { url: "https://s1-bos.liveatc.net/kjfk_twr", name: "United States - New York: KJFK Tower" },
    { url: "https://s1-bos.liveatc.net/kjfk9_s", name: "United States - New York: KJFK Gnd/Twr" },
    { url: "https://s1-bos.liveatc.net/klax_twr", name: "United States - Los Angeles: KLAX Tower (North/South) #1" },
    { url: "https://s1-bos.liveatc.net/klax6", name: "United States - Los Angeles: KLAX Final App (North/South)" },
    { url: "https://s1-bos.liveatc.net/kord7", name: "United States - Chicago: KORD Tower" },
    { url: "https://s1-bos.liveatc.net/kpdx3_twr", name: "United States - Portland: KPDX Tower (Both)" },
    { url: "https://s1-bos.liveatc.net/kphx_twr_both", name: "United States - Phoenix: KPHX Tower (North/South)" },
    { url: "https://s1-bos.liveatc.net/ksan1_all", name: "United States - San Diego: KSAN Ramp/Del/Gnd/Twr" },
    { url: "https://s1-bos.liveatc.net/ksan1_twr", name: "United States - San Diego: KSAN Tower #1" },
    { url: "https://s1-bos.liveatc.net/ksea2_air", name: "United States - Seattle: KSEA Air-to-Air" },
    { url: "https://s1-bos.liveatc.net/ksea2_twr_e", name: "United States - Seattle: KSEA Tower (16L/34R,16C/34C) #2" },
    { url: "https://s1-bos.liveatc.net/ksfo_twr", name: "United States - San Francisco: KSFO Tower" },
    { url: "https://s1-bos.liveatc.net/ksfo_twr2", name: "United States - San Francisco: KSFO Tower/Ground" },
    { url: "https://s1-bos.liveatc.net/lhbp_app2", name: "Hungary - Budapest: LHBP Approach" },
    { url: "https://s1-bos.liveatc.net/mmgl", name: "Mexico - Guadalajara: MMGL Twr/App" },
    { url: "https://s1-bos.liveatc.net/mmmx1_twr", name: "Mexico - Mexico City: MMMX Tower" },
    { url: "https://s1-bos.liveatc.net/mroc", name: "Costa Rica - San Jose: MROC Del/Gnd/Twr/App/Center/Misc" },
    { url: "https://s1-bos.liveatc.net/panc", name: "United States - Anchorage: PANC Del/Gnd/Twr/App" },
    { url: "https://s1-bos.liveatc.net/phnl1_twr_pri", name: "United States - Honolulu: PHNL Tower (Primary)" },
    { url: "https://s1-bos.liveatc.net/phnl1_twr", name: "United States - Honolulu: PHNL Tower (Both)" },
    { url: "https://s1-bos.liveatc.net/rcss2", name: "Taiwan - Taipei: RCSS Tower/App/Dep" },
    { url: "https://s1-bos.liveatc.net/rjaa_app_s", name: "Japan - Tokyo: RJAA Approach" },
    { url: "https://s1-bos.liveatc.net/rjaa_del", name: "Japan - Tokyo: RJAA Clearance Delivery" },
    { url: "https://s1-bos.liveatc.net/rjaa_twr", name: "Japan - Tokyo: RJAA Tower (Both)" },
    { url: "https://s1-bos.liveatc.net/rjoo1", name: "Japan - Osaka: RJOO Tower" },
    { url: "https://s1-bos.liveatc.net/rjtt_app_dep", name: "Japan - Tokyo: RJTT App/Dep" },
    { url: "https://s1-bos.liveatc.net/rjtt_app", name: "Japan - Tokyo: RJTT Approach" },
    { url: "https://s1-bos.liveatc.net/rjtt_control", name: "Japan - Tokyo: RJTT Tokyo Control" },
    { url: "https://s1-bos.liveatc.net/rjtt_twr", name: "Japan - Tokyo: RJTT Twr/TCA" },
    { url: "https://s1-bos.liveatc.net/rjtt2", name: "Japan - Tokyo: RJTT Company Channels" },
    { url: "https://s1-bos.liveatc.net/rjty1_gnd_twr", name: "Japan - Tokyo: RJTY Ground/Tower" },
    { url: "https://s1-bos.liveatc.net/sbfz4", name: "Brazil - Fortaleza: SBFZ Twr/App/Center" },
    { url: "https://s1-bos.liveatc.net/scel", name: "Chile - Santiago: SCEL Gnd/Twr/Radar" },
    { url: "https://s1-bos.liveatc.net/unnt", name: "Russia - Novosibirsk: UNNT Gnd/Twr/App/Radar/Misc" },
    { url: "https://s1-bos.liveatc.net/vhhh5", name: "Hong Kong - Hong Kong: VHHH App/Dep/Dir/Zone" },
    { url: "https://s1-bos.liveatc.net/yssy1_twr", name: "Australia - Sydney: YSSY Tower (Both)" },
    { url: "https://s1-bos.liveatc.net/zoa_sfo", name: "United States - San Francisco: ZOA Oakland Center (35/40/41)" }
];

// Subtitle "puns"
var subtitles = [
    'ATChre',
    'ATC to Arasaka',
    'Boards of AirCanada',
    'Aphex Twin-Engine',
    'Polygon Window-Seat',
    'Tinpusher',
    'Preflight 73',
    'Plane (...like Plone, get it?)',
    'Tail # n5MD',
    'ATC Krew',
    'F.U.S.E.lage',
    'PanAm Sonic'
];

// --- Some globals
var videos = [];
var videoIndex = 0;
var totalVideos = 0;
var unavailableTimeout = null;
var metadataTimeout = null;

// --- Some initialization stepps...

// Set the subtitle randomly...
document.getElementById('subtitle').innerText = subtitles[Math.floor(Math.random() * subtitles.length)];

// Set up the ATC volume slider...
var atcSlider = document.getElementById("atcVolumeSlider");
setAtcVolume(atcSlider.value / 100.0);
// Update the current slider value (each time you drag the slider handle)
atcSlider.oninput = function () {
    setAtcVolume(this.value / 100.0);
}

// Queue up a random ATC when we load...
playRandomAtc();

// ATC Functions
function playRandomAtc() {
    var atc = atcStreams[Math.floor(Math.random() * atcStreams.length)];
    var atcplayer = document.getElementById('atcplayer');
    atcplayer.src = atc.url;
    document.getElementById("atcData").innerText = atc.name;    
}

function setAtcVolume(pvol) {
    var atcplayer = document.getElementById('atcplayer');
    atcplayer.volume = pvol;
}

// --- YouTube config stuff...
// YouTube - load the IFrame Player API code asynchronously.
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// This function creates an <iframe> (and YouTube player) after the API code downloads.
var player;
function onYouTubeIframeAPIReady() {
    player = new YT.Player('ytplayer', {
        height: '1',
        width: '1',
        // videoId: '',
        playerVars: {
            'playsinline': 1
        },
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
            'onError': onError
        }
    });
}

// The API will call this function when the video player is ready.
function onPlayerReady(event) {
    // Prep our list of videos...
    createVideoList();

    // Configure the volume slider...
    var slider = document.getElementById("musicVolumeSlider");
    player.setVolume(slider.value);

    // Add event to update the current slider value (each time you drag the slider handle)
    slider.oninput = function () {
        player.setVolume(this.value);
    }

    // Start first video playing...
    playNext();
}

// 5. The API calls this function when the player's state changes.
// var done = false;
function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
    } else if (event.data == YT.PlayerState.CUED) {
        player.playVideo();
        // Could call updateMetadataOfPlayingTrack(); here, but
        // for whatever reason, 'author' comes in late... we'll just update on the callback timer.
    } else if (event.data == YT.PlayerState.ENDED) {
        playNext();
    } else if (event.data == YT.PlayerState.UNSTARTED) {
    }
}

function updateMetadataOfPlayingTrack() {
    if (player === null) {
        return;
    }
    var videoMetadata = player.getVideoData();
    if (videoMetadata != null) {
        var videoTitle = 'next track';
        if (videoMetadata.author === null || videoMetadata.author === '') {
            videoTitle = videoMetadata.title;
        } else {
            videoTitle = videoMetadata.author + ' - ' + videoMetadata.title;
        }
        document.getElementById("videoData").innerText = videoTitle;
    }
}

// Just in case...
function onError(event) {
    console.log(event);
}

// Button functions... could probably just do these inline, but /shrug.
function stopVideo() {
    player.stopVideo();
    clearTimeout(unavilableTimeout);
}
function pause() {
    player.pauseVideo();
    clearTimeout(unavilableTimeout);
}
function unpause() {
    player.playVideo();
}
function skip() {
    playNext();
}
function openInYouTube() {
    var url = player.getVideoUrl();
    window.open(url, '_blank');
}

// Function to prep our list of videos...
function createVideoList() {
    videos = [];
    videoIndex = 0;
    totalVideos = 0;
    for (let i = 0; i < playlists.length; i++) {
        for (let v = 0; v < playlists[i].entries.length; v++) {
            videos.push({
                playlistNum: i,
                video: playlists[i].entries[v]
            });
            totalVideos++;
        }
    }
    // Random sort the list:
    videos.sort(function () { return 0.5 - Math.random() });
}

// Function to get the next video in our randomly-sorted list...
function getNextVideo() {
    while (true) {
        var vid = videos[videoIndex++];
        // If we reach the end, reshuffle and start again.
        if (videoIndex >= totalVideos) {
            createVideoList();
            videoIndex = 0;
        }

        if (playlists[vid.playlistNum].include === true) {
            return vid.video;
        }
    }
}

function onMetadataUpdateTimer() {
    updateMetadataOfPlayingTrack();
    metadataTimeout = setTimeout(onMetadataUpdateTimer, 5000);
}

// Function we call a couple seconds after attempting to cue the track.
function onNextTrackCallback() {
    // If we haven't started a track after the timeout for some reason, then try the next track.
    if (player.getCurrentTime() === 0 || player.getPlayerState() === YT.PlayerState.UNSTARTED) {
        playNext();
    }
}

// Function to play the next track (either because it's the first, the previous one ended, or the user clicked 'skip')
function playNext() {
    if (unavailableTimeout != null) {
        clearTimeout(unavailableTimeout);
    }
    player.cueVideoById(getNextVideo());
    unavilableTimeout = setTimeout(onNextTrackCallback, 10000); // let's give a 10 second timeout in case the videos don't load
    onMetadataUpdateTimer();
}